<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×¨×˜×™ ×”×¢×‘×¨×” ×‘× ×§××™×ª - TICO</title>
    <link href="https://fonts.googleapis.com/css2?family=David+Libre:wght@400;500;700&family=Assistant:wght@400;500;600;700&family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @media print {
            body {
                margin: 0;
                padding: 20px;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body style="margin: 0; padding: 20px; font-family: 'Assistant', 'Heebo', Arial, sans-serif; background-color: #f5f5f7; direction: rtl;">
    <!-- Main container -->
    <table width="700" cellpadding="0" cellspacing="0" border="0" style="margin: 0 auto; background-color: #ffffff; border-radius: 8px; border: 1px solid #e4e4e7; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">

        <!-- Header Component (matches letter templates) -->
        <!-- Row 1: Logo centered -->
        <tr>
            <td style="text-align: center; padding: 40px 40px 10px 40px;">
                <img src="https://ticovision.vercel.app/brand/Tico_logo_png_new.png" width="180" height="80" alt="TICO" style="display: block; margin: 0 auto; border: 0;">
            </td>
        </tr>

        <!-- Row 2: Thick black horizontal line -->
        <tr>
            <td style="padding: 0 40px;">
                <div style="border-top: 13px solid #000000; margin: 20px 0;"></div>
            </td>
        </tr>

        <!-- Row 3: Recipient (right) and Date (left) -->
        <tr>
            <td style="padding: 0 40px;">
                <table width="100%" cellpadding="0" cellspacing="0" border="0">
                    <tr>
                        <!-- Recipient (right side in RTL) -->
                        <td width="50%" style="vertical-align: top; text-align: right;">
                            <div style="font-family: 'David Libre', 'Heebo', 'Assistant', sans-serif; font-size: 18px; line-height: 1.2; font-weight: 700; color: #000000;">
                                ×œ×›×‘×•×“:<br>
                                <span id="company-name">___________________</span><br>
                                <span id="group-name"></span>
                            </div>
                        </td>
                        <!-- Date (left side in RTL) -->
                        <td width="50%" style="vertical-align: top; text-align: left;">
                            <div style="font-family: 'David Libre', 'Heebo', 'Assistant', sans-serif; font-size: 18px; line-height: 1.2; font-weight: 700; color: #000000;">
                                <span id="letter-date"></span>
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>

        <!-- Title -->
        <tr>
            <td style="padding: 20px 40px 24px 40px;">
                <div style="font-size: 24px; line-height: 1.4; font-weight: 700; color: #09090b; text-align: center;">
                    ×¤×¨×˜×™ ×”×¢×‘×¨×” ×‘× ×§××™×ª
                </div>
            </td>
        </tr>

        <!-- Amount to pay -->
        <tr>
            <td style="padding: 0 40px 30px 40px;">
                <div style="background-color: #f3f4f6; border-radius: 8px; padding: 24px; text-align: center;">
                    <div style="font-size: 19px; font-weight: 600; color: #09090b; margin-bottom: 16px;">
                        ×©××—×™× ×©×‘×—×¨×ª× ×‘×ª×©×œ×•× ×‘×”×¢×‘×¨×” ×‘× ×§××™×ª
                    </div>
                    <div style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 12px;">
                        ×‘×ª××•×¨×” ××©×¨×“× ×• ×™×¢× ×™×§ ×œ×›× ×”× ×—×” ×©×œ 9%
                    </div>
                    <div style="font-size: 17px; color: #09090b; line-height: 1.6; margin-bottom: 8px;">
                        ×”×¡×›×•× ×›×•×œ×œ ××¢"× ×œ×¤× ×™ ×”× ×—×” ×”×•× â‚ª<span id="amount-original">10,000</span>
                    </div>
                    <div style="font-size: 17px; color: #09090b; line-height: 1.6; margin-bottom: 16px;">
                        ×•×”×¡×›×•× ×œ××—×¨ ×”×”× ×—×” ×”×•× â‚ª<span id="amount-after">9,100</span> ×›×•×œ×œ ××¢"×
                    </div>
                    <div style="border-top: 2px solid #2c3e50; padding-top: 16px; margin-top: 16px;">
                        <div style="font-size: 16px; color: #71717a; margin-bottom: 8px;">
                            ×¡×›×•× ×œ×ª×©×œ×•×:
                        </div>
                        <div style="font-size: 36px; font-weight: 700; color: #09090b;">
                            â‚ª<span id="amount-final">9,100</span>
                        </div>
                    </div>
                </div>
            </td>
        </tr>

        <!-- Border -->
        <tr>
            <td style="padding: 0 40px 30px 40px;">
                <div style="border-top: 1px solid #e4e4e7;"></div>
            </td>
        </tr>

        <!-- Bank Details -->
        <tr>
            <td style="padding: 0 40px 30px 40px;">
                <div style="font-size: 18px; font-weight: 600; color: #09090b; text-align: right; margin-bottom: 20px;">
                    ×¤×¨×˜×™ ×—×©×‘×•×Ÿ ×”×‘× ×§:
                </div>

                <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #fafafa; border-radius: 6px; padding: 20px;">
                    <tr>
                        <td style="padding: 12px 0; border-bottom: 1px solid #e4e4e7;">
                            <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td width="40%" style="font-size: 15px; color: #71717a; text-align: right;">
                                        ×©× ×”××•×˜×‘:
                                    </td>
                                    <td width="60%" style="font-size: 16px; font-weight: 600; color: #09090b; text-align: right;">
                                        ×¤×¨× ×§×• ×•×©×•×ª' ×¨×•"×—
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 0; border-bottom: 1px solid #e4e4e7;">
                            <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td width="40%" style="font-size: 15px; color: #71717a; text-align: right;">
                                        ×‘× ×§:
                                    </td>
                                    <td width="60%" style="font-size: 16px; font-weight: 600; color: #09090b; text-align: right;">
                                        ×‘× ×§ ×”×¤×•×¢×œ×™× (12)
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 0; border-bottom: 1px solid #e4e4e7;">
                            <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td width="40%" style="font-size: 15px; color: #71717a; text-align: right;">
                                        ×¡× ×™×£:
                                    </td>
                                    <td width="60%" style="font-size: 16px; font-weight: 600; color: #09090b; text-align: right;">
                                        532
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 0;">
                            <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                <tr>
                                    <td width="40%" style="font-size: 15px; color: #71717a; text-align: right;">
                                        ××¡×¤×¨ ×—×©×‘×•×Ÿ:
                                    </td>
                                    <td width="60%" style="font-size: 16px; font-weight: 600; color: #09090b; text-align: right;">
                                        539990
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>

        <!-- Important Note -->
        <tr>
            <td style="padding: 0 40px 30px 40px;">
                <div style="background-color: #f3f4f6; border: 1px solid #e4e4e7; padding: 20px; border-radius: 6px;">
                    <div style="font-size: 16px; font-weight: 600; color: #09090b; margin-bottom: 8px; text-align: right;">
                        ×—×©×•×‘!
                    </div>
                    <div style="font-size: 15px; color: #09090b; line-height: 1.6; text-align: right;">
                        ×™×© ×œ×¦×™×™×Ÿ ×‘×”×¢×‘×¨×” ××ª ×©× ×”×œ×§×•×— ×•××¡×¤×¨ ×ª.×– / ×—.×¤ ×œ×”×–×“×”×•×ª
                    </div>
                </div>
            </td>
        </tr>

        <!-- Border -->
        <tr>
            <td style="padding: 0 40px 30px 40px;">
                <div style="border-top: 1px solid #e4e4e7;"></div>
            </td>
        </tr>

        <!-- Confirmation Form -->
        <tr>
            <td style="padding: 0 40px 40px 40px;">
                <div style="font-size: 18px; font-weight: 600; color: #09090b; text-align: right; margin-bottom: 20px;">
                    ××™×©×•×¨ ×‘×™×¦×•×¢ ×”×¢×‘×¨×”:
                </div>

                <form id="confirmForm" style="background-color: #fafafa; border-radius: 6px; padding: 24px;">
                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 15px; font-weight: 500; color: #09090b; display: block; margin-bottom: 8px; text-align: right;">
                            ×©× ××œ×:
                        </label>
                        <input type="text" id="fullName" required style="width: 100%; padding: 12px; border: 1px solid #e4e4e7; border-radius: 4px; font-size: 15px; font-family: 'Assistant', 'Heebo', Arial, sans-serif; direction: rtl; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 15px; font-weight: 500; color: #09090b; display: block; margin-bottom: 8px; text-align: right;">
                            ×“×•×"×œ:
                        </label>
                        <input type="email" id="email" required style="width: 100%; padding: 12px; border: 1px solid #e4e4e7; border-radius: 4px; font-size: 15px; font-family: 'Assistant', 'Heebo', Arial, sans-serif; direction: ltr; text-align: left; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 15px; font-weight: 500; color: #09090b; display: block; margin-bottom: 8px; text-align: right;">
                            ×ª××¨×™×š ×”×¢×‘×¨×”:
                        </label>
                        <input type="date" id="transferDate" required style="width: 100%; padding: 12px; border: 1px solid #e4e4e7; border-radius: 4px; font-size: 15px; font-family: 'Assistant', 'Heebo', Arial, sans-serif; direction: rtl; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="font-size: 15px; font-weight: 500; color: #09090b; display: block; margin-bottom: 8px; text-align: right;">
                            ×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™):
                        </label>
                        <textarea id="notes" rows="3" style="width: 100%; padding: 12px; border: 1px solid #e4e4e7; border-radius: 4px; font-size: 15px; font-family: 'Assistant', 'Heebo', Arial, sans-serif; direction: rtl; resize: vertical; box-sizing: border-box;"></textarea>
                    </div>

                    <div style="text-align: center;">
                        <button type="submit" style="background-color: #09090b; color: #ffffff; padding: 14px 40px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; font-family: 'Assistant', 'Heebo', Arial, sans-serif;">
                            ××™×©×•×¨ ×‘×™×¦×•×¢ ×”×¢×‘×¨×”
                        </button>
                    </div>
                </form>

                <div id="successMessage" style="display: none; background-color: #f3f4f6; border: 2px solid #09090b; padding: 20px; border-radius: 6px; margin-top: 20px; text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: #09090b;">
                        âœ… ×ª×•×“×”! ×§×™×‘×œ× ×• ××ª ×”××™×©×•×¨
                    </div>
                    <div style="font-size: 16px; color: #09090b; margin-top: 8px;">
                        ×¡×™×’×œ ×ª×™×¦×•×¨ ××™×ª×š ×§×©×¨ ×‘×§×¨×•×‘ ×œ××™×©×•×¨ ×§×‘×œ×ª ×”×ª×©×œ×•×
                    </div>
                </div>
            </td>
        </tr>

        <!-- Footer Component (matches letter templates) -->
        <!-- FOOTER: Logo & Contact Details -->
        <tr>
            <td style="padding: 20px 40px 0 40px;">
                <div style="border-top: 13px solid #000000; margin-bottom: 25px;"></div>
                <table width="100%" cellpadding="0" cellspacing="0" border="0" style="padding-top: 0px; padding-bottom: 20px;">
                    <tr>
                        <!-- Logo Column - 30% -->
                        <td width="30%" style="vertical-align: middle; text-align: right; padding-left: 0;">
                            <img src="https://ticovision.vercel.app/brand/Tico_franco_co.png" width="135" height="95" alt="TICO FRANCO & CO" style="display: block; margin-left: auto; margin-right: 0; border: 0;">
                        </td>
                        <!-- Gap -->
                        <td width="24.5%"></td>
                        <!-- Contact Details - 45.5% -->
                        <td width="45.5%" style="vertical-align: middle; text-align: right;">
                            <div style="font-family: 'David Libre', 'Heebo', 'Assistant', sans-serif; font-size: 16px; line-height: 1.8; color: #71717a; padding-bottom: 4px;">
                                <img src="https://ticovision.vercel.app/brand/icon-building.png" width="22" height="22" alt="ğŸ“" style="display: inline-block; vertical-align: middle; margin-left: 6px; border: 0;">
                                ×©×“"×œ 3, ××’×“×œ ××œ×¨×•×‘ ×§×•××” ×¨××©×•× ×”, ×ª×œ ××‘×™×‘
                            </div>
                            <div style="font-family: 'David Libre', 'Heebo', 'Assistant', sans-serif; font-size: 16px; line-height: 1.8; color: #71717a; padding-bottom: 4px;">
                                <img src="https://ticovision.vercel.app/brand/icon-phone.png" width="22" height="22" alt="ğŸ“" style="display: inline-block; vertical-align: middle; margin-left: 6px; border: 0;">
                                03-5666170
                            </div>
                            <div style="font-family: 'David Libre', 'Heebo', 'Assistant', sans-serif; font-size: 16px; line-height: 1.8; color: #71717a;">
                                <img src="https://ticovision.vercel.app/brand/icon-email.png" width="22" height="17" alt="ğŸ“§" style="display: inline-block; vertical-align: middle; margin-left: 6px; border: 0;">
                                tico@franco.co.il
                            </div>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>

        <!-- FOOTER: Bottom Border -->
        <tr>
            <td style="padding: 0 40px;">
                <div style="border-top: 13px solid #000000; margin-top: 20px;"></div>
            </td>
        </tr>

        <!-- FOOTER: Tagline -->
        <tr>
            <td style="padding: 30px 40px 40px 40px;">
                <img src="https://ticovision.vercel.app/brand/tagline.png" width="800" height="113" alt="DARE TO THINK Â· COMMIT TO DELIVER" style="display: block; width: 100%; max-width: 800px; height: auto; border: 0;">
            </td>
        </tr>

    </table>

    <script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('client_id') || 'unknown';
        // Get both amounts from URL - Edge Function already calculated the discount
        const originalAmountParam = urlParams.get('original_amount') || urlParams.get('amount') || '10,000';
        const amountAfterParam = urlParams.get('amount') || '10,000';
        const companyName = urlParams.get('company_name') || '×œ×§×•×—';
        const groupName = urlParams.get('group_name') || '';

        // Set current date in Israeli format (DD.MM.YYYY)
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const formattedDate = `${day}.${month}.${year}`;
        document.getElementById('letter-date').textContent = formattedDate;

        // Set company name and group name
        // Always display company name (even if fallback)
        document.getElementById('company-name').textContent = companyName;

        if (groupName) {
            document.getElementById('group-name').textContent = groupName;
        } else {
            document.getElementById('group-name').style.display = 'none';
        }

        // Format amounts for display (already calculated by Edge Function)
        const originalAmount = parseFloat(originalAmountParam.replace(/,/g, '')).toLocaleString('he-IL');
        const amountAfterDiscount = parseFloat(amountAfterParam.replace(/,/g, '')).toLocaleString('he-IL');

        // Update all amount displays - NO recalculation needed!
        document.getElementById('amount-original').textContent = originalAmount;
        document.getElementById('amount-after').textContent = amountAfterDiscount;
        document.getElementById('amount-final').textContent = amountAfterDiscount;

        // Handle form submission
        document.getElementById('confirmForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                client_id: clientId,
                amount: amountAfterDiscount,  // Amount after discount
                amount_original: originalAmount,  // Original amount before discount
                full_name: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                transfer_date: document.getElementById('transferDate').value,
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString()
            };

            try {
                // Send email to Sigal
                const response = await fetch('/api/notify-bank-transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    // Show success message
                    document.getElementById('confirmForm').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';

                    // Log to console (temporary - will be saved to database later)
                    console.log('Bank transfer confirmation:', formData);
                } else {
                    alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”××™×©×•×¨. ×× × × ×¡×” ×©×•×‘ ××• ×¦×•×¨ ×§×©×¨ ×¢× ×¡×™×’×œ.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”××™×©×•×¨. ×× × × ×¡×” ×©×•×‘ ××• ×¦×•×¨ ×§×©×¨ ×¢× ×¡×™×’×œ.');
            }
        });
    </script>
</body>
</html>
