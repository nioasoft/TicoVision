---
phase: 03-chat-ui-components
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/modules/annual-balance/components/BalanceChatSheet.tsx
  - src/modules/annual-balance/components/BalanceChatMessages.tsx
  - src/modules/annual-balance/components/BalanceChatInput.tsx
  - src/modules/annual-balance/components/BalanceTable.tsx
  - src/modules/annual-balance/pages/AnnualBalancePage.tsx
  - src/modules/annual-balance/index.ts
autonomous: true

must_haves:
  truths:
    - "User can click a chat icon on any balance row to open a side panel Sheet"
    - "Messages display in a scrollable list showing sender name, timestamp, and content (newest at bottom)"
    - "User can type and send a text message that appears immediately via optimistic update"
    - "Chat panel shows a loading spinner while fetching message history"
    - "Chat panel shows an empty state with Hebrew message when no messages exist"
  artifacts:
    - path: "src/modules/annual-balance/components/BalanceChatSheet.tsx"
      provides: "Sheet side panel composing messages list and input"
      contains: "SheetContent"
    - path: "src/modules/annual-balance/components/BalanceChatMessages.tsx"
      provides: "Scrollable message list with own/other styling, loading, empty state"
      contains: "BalanceChatMessageWithSender"
    - path: "src/modules/annual-balance/components/BalanceChatInput.tsx"
      provides: "Text input with send button and Enter-to-send"
      contains: "handleSend"
    - path: "src/modules/annual-balance/components/BalanceTable.tsx"
      provides: "Chat icon button on each balance row"
      contains: "MessageCircle"
    - path: "src/modules/annual-balance/pages/AnnualBalancePage.tsx"
      provides: "Chat state management and BalanceChatSheet rendering"
      contains: "BalanceChatSheet"
  key_links:
    - from: "src/modules/annual-balance/components/BalanceChatSheet.tsx"
      to: "src/modules/annual-balance/services/balance-chat.service.ts"
      via: "balanceChatService.getMessages() and .sendMessage()"
      pattern: "balanceChatService\\.getMessages|balanceChatService\\.sendMessage"
    - from: "src/modules/annual-balance/components/BalanceChatSheet.tsx"
      to: "src/modules/annual-balance/components/BalanceChatMessages.tsx"
      via: "component composition"
      pattern: "<BalanceChatMessages"
    - from: "src/modules/annual-balance/components/BalanceChatSheet.tsx"
      to: "src/modules/annual-balance/components/BalanceChatInput.tsx"
      via: "component composition"
      pattern: "<BalanceChatInput"
    - from: "src/modules/annual-balance/components/BalanceTable.tsx"
      to: "src/modules/annual-balance/pages/AnnualBalancePage.tsx"
      via: "onChatClick callback prop"
      pattern: "onChatClick"
    - from: "src/modules/annual-balance/pages/AnnualBalancePage.tsx"
      to: "src/modules/annual-balance/components/BalanceChatSheet.tsx"
      via: "rendering Sheet with chatOpen and chatBalanceCase state"
      pattern: "<BalanceChatSheet"
---

<objective>
Build the complete chat UI for the annual-balance module: a Sheet side panel with message display, text input, loading state, empty state, and optimistic send -- wired into the balance table via a chat icon on each row.

Purpose: Users can communicate about specific balance cases without leaving the annual-balance page. This is the first visible chat surface in the feature.
Output: 3 new components (BalanceChatSheet, BalanceChatMessages, BalanceChatInput), modified BalanceTable with chat icon, modified AnnualBalancePage with chat state management, updated module exports.
</objective>

<execution_context>
@/Users/asafbenatia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/asafbenatia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chat-service-layer/02-01-SUMMARY.md
@.planning/phases/03-chat-ui-components/03-RESEARCH.md

# Key source files to reference during implementation
@src/modules/annual-balance/services/balance-chat.service.ts
@src/modules/annual-balance/types/balance-chat.types.ts
@src/modules/annual-balance/components/BalanceTable.tsx
@src/modules/annual-balance/pages/AnnualBalancePage.tsx
@src/modules/annual-balance/index.ts

# Reference patterns (read for pattern, do NOT import from)
@src/modules/chat/components/MessageThread.tsx
@src/modules/chat/components/MessageInput.tsx
@src/components/ui/sheet.tsx
@src/contexts/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BalanceChatMessages, BalanceChatInput, and BalanceChatSheet components</name>
  <files>
    src/modules/annual-balance/components/BalanceChatMessages.tsx
    src/modules/annual-balance/components/BalanceChatInput.tsx
    src/modules/annual-balance/components/BalanceChatSheet.tsx
  </files>
  <action>
Create 3 new components in `src/modules/annual-balance/components/`. Follow the existing MessageThread and MessageInput patterns from `src/modules/chat/components/` but adapted for the balance-specific service. Do NOT import from `src/modules/chat/` -- these are separate systems.

**BalanceChatMessages.tsx** (~80-100 lines):
- Props: `messages: BalanceChatMessageWithSender[]`, `loading: boolean`, `currentUserId: string`
- Import `BalanceChatMessageWithSender` from `../types/balance-chat.types`
- Loading state: centered `Loader2` spinner with `animate-spin` (match MessageThread pattern)
- Empty state: centered Hebrew text `אין הודעות עדיין. התחל שיחה!` with `text-muted-foreground text-sm`
- Message list: `div` with `flex-1 overflow-y-auto p-3 space-y-2`
- Date separator: Group messages by date using inline `formatDate()` helper (copy from MessageThread: today=היום, yesterday=אתמול, else DD/MM/YYYY using `he-IL` locale)
- Time display: inline `formatTime()` helper returning HH:MM in `he-IL` locale
- Own message alignment: `isOwn = msg.user_id === currentUserId` (note: `user_id` not `sender_id` -- BalanceChatMessageRow uses `user_id`)
  - Own messages: `justify-start` (right side in RTL), `bg-primary text-primary-foreground`
  - Other messages: `justify-end` (left side in RTL), `bg-gray-100 text-gray-900`
- Sender name: Show `msg.sender_name` only for non-own messages, in `text-xs font-medium mb-1 opacity-70`
- Content: `whitespace-pre-wrap break-words` for multi-line support
- Timestamp: `text-[10px] mt-1 opacity-70` (for own) or `text-muted-foreground` (for others)
- Auto-scroll: `useRef<HTMLDivElement>(null)` for `bottomRef`, `useEffect` scrolling to bottom on `messages` change with `{ behavior: 'smooth' }`
- `<div ref={bottomRef} />` at end of message list

**BalanceChatInput.tsx** (~50-60 lines):
- Props: `onSend: (content: string) => Promise<void>`, `disabled?: boolean`
- Local state: `text` (string), `sending` (boolean)
- `handleSend`: trim text, check non-empty, set `sending=true`, call `onSend(text.trim())`, clear text on success (no error handling here -- parent handles via toast), set `sending=false`
- Enter-to-send: `handleKeyDown` callback -- if `Enter` without `Shift`, preventDefault and call handleSend
- Layout: `div` with `flex items-center gap-2 p-3 border-t`
- Input: shadcn `Input` with `value={text}`, `onChange`, `onKeyDown`, `placeholder="כתוב הודעה..."`, `className="rtl:text-right"`, `disabled={sending || disabled}`
- Send button: shadcn `Button` with `size="icon"`, `disabled={sending || !text.trim() || disabled}`, `className="shrink-0"`
  - Icon: `Loader2` (animate-spin) when sending, `Send` otherwise
  - Both from lucide-react

**BalanceChatSheet.tsx** (~120-150 lines):
- Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `balanceCase: AnnualBalanceSheetWithClient | null`
- Import: `Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription` from `@/components/ui/sheet`
- Import: `balanceChatService` from `../services/balance-chat.service`
- Import: `BalanceChatMessageWithSender` from `../types/balance-chat.types`
- Import: `AnnualBalanceSheetWithClient` from `../types/annual-balance.types`
- Import: `useAuth` from `@/contexts/AuthContext`
- Import: `toast` from `sonner`
- Import: `BalanceChatMessages` and `BalanceChatInput`
- State: `messages: BalanceChatMessageWithSender[]` (useState, default []), `loading: boolean` (useState, default false)
- Get `{ user }` from `useAuth()`
- Fetch messages: `useEffect` with deps `[open, balanceCase?.id]`. When `open && balanceCase?.id`: set `loading=true`, call `balanceChatService.getMessages(balanceCase.id)`, if error `toast.error('שגיאה בטעינת ההודעות')`, else `setMessages(result.data ?? [])`, finally `setLoading(false)`
- Send handler `handleSend(content: string)`: Optimistic update pattern:
  1. Build optimistic message matching `BalanceChatMessageWithSender` type: `id: crypto.randomUUID()`, `tenant_id: ''`, `balance_id: balanceCase.id`, `user_id: user.id`, `content`, `message_type: 'user' as const`, `is_deleted: false`, `deleted_at: null`, `deleted_by: null`, `created_at: new Date().toISOString()`, `sender_name: user.user_metadata?.full_name || user.email || ''`, `sender_email: user.email || ''`
  2. Immediately add to messages: `setMessages(prev => [...prev, optimisticMsg])`
  3. Call `balanceChatService.sendMessage(balanceCase.id, content)`
  4. On error: remove optimistic message `setMessages(prev => prev.filter(m => m.id !== optimisticMsg.id))`, `toast.error('שגיאה בשליחת ההודעה')`
  5. On success: replace optimistic with real `setMessages(prev => prev.map(m => m.id === optimisticMsg.id ? result.data! : m))`
- Sheet layout: `side="left"` (secondary side in RTL), `className="w-[400px] sm:max-w-[420px] p-0 flex flex-col"`, `dir="rtl"`
- Header: `SheetHeader` with `className="p-4 border-b"`, `SheetTitle` with `className="text-right"` showing `שיחה - {balanceCase.client?.company_name}`, `SheetDescription` with `className="text-right"` showing `{balanceCase.client?.tax_id} | שנת {balanceCase.year}`
- Body: `<BalanceChatMessages messages={messages} loading={loading} currentUserId={user?.id || ''} />`
- Footer: `<BalanceChatInput onSend={handleSend} disabled={!balanceCase} />`
- Render nothing meaningful if `!balanceCase` but keep Sheet open/closed controlled by parent

JSDoc comment at top of each file explaining the component's purpose.
  </action>
  <verify>
Run `npm run typecheck` to verify all 3 new files compile without TypeScript errors. Verify files exist:
- `ls src/modules/annual-balance/components/BalanceChatSheet.tsx`
- `ls src/modules/annual-balance/components/BalanceChatMessages.tsx`
- `ls src/modules/annual-balance/components/BalanceChatInput.tsx`
  </verify>
  <done>
Three new components exist and pass TypeScript checking. BalanceChatSheet composes BalanceChatMessages + BalanceChatInput, calls balanceChatService for data, handles optimistic send, and renders loading/empty states in Hebrew.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire chat icon into BalanceTable and mount BalanceChatSheet in AnnualBalancePage</name>
  <files>
    src/modules/annual-balance/components/BalanceTable.tsx
    src/modules/annual-balance/pages/AnnualBalancePage.tsx
    src/modules/annual-balance/index.ts
  </files>
  <action>
Wire the new chat components into the existing balance table and page.

**BalanceTable.tsx modifications:**
1. Add `onChatClick: (row: AnnualBalanceSheetWithClient) => void` to `BalanceTableProps` interface
2. Add `onChatClick` to the destructured props
3. Add `MessageCircle` to the lucide-react import (alongside existing ChevronRight, ChevronLeft, FileSearch, ExternalLink, AlertTriangle)
4. In each table row, inside the existing "Quick action" `<TableCell>` (line 281 area, which already has `onClick={(e) => e.stopPropagation()}`), add a chat icon button BEFORE the existing `{canAdvance && actionLabel ? (...)  : (...)}` block:
   ```tsx
   <Button
     variant="ghost"
     size="icon"
     className="h-7 w-7 shrink-0"
     onClick={() => onChatClick(row)}
   >
     <MessageCircle className="h-4 w-4 text-muted-foreground" />
   </Button>
   ```
   This goes inside the existing `<div className="flex items-center gap-1">` so it sits alongside the quick action button. The `stopPropagation` is already on the parent `<TableCell>`.
5. Also add the same chat icon to the skeleton loading state -- add a `<Skeleton className="h-7 w-7 rounded" />` in the first column skeleton.

**AnnualBalancePage.tsx modifications:**
1. Add import for `BalanceChatSheet` from `../components/BalanceChatSheet`
2. Add two new state variables after the existing dialog states (around line 60):
   ```typescript
   const [chatOpen, setChatOpen] = useState(false);
   const [chatBalanceCase, setChatBalanceCase] = useState<AnnualBalanceSheetWithClient | null>(null);
   ```
3. Add `handleChatClick` callback (useCallback):
   ```typescript
   const handleChatClick = useCallback((row: AnnualBalanceSheetWithClient) => {
     setChatBalanceCase(row);
     setChatOpen(true);
   }, []);
   ```
4. Pass `onChatClick={handleChatClick}` to the `<BalanceTable>` component (add alongside existing props like onRowClick, onQuickAction)
5. Render `<BalanceChatSheet>` after the existing dialogs (before the closing `</div>` of the page):
   ```tsx
   <BalanceChatSheet
     open={chatOpen}
     onOpenChange={setChatOpen}
     balanceCase={chatBalanceCase}
   />
   ```

**index.ts modifications:**
Add exports for the 3 new components at the bottom of the Components section:
```typescript
export { BalanceChatSheet } from './components/BalanceChatSheet';
export { BalanceChatMessages } from './components/BalanceChatMessages';
export { BalanceChatInput } from './components/BalanceChatInput';
```

Also add the Phase 2 types/service exports if not already present:
```typescript
// Chat types
export type { BalanceChatMessageWithSender, BalanceChatMessageRow, MessageType } from './types/balance-chat.types';

// Chat service
export { balanceChatService } from './services/balance-chat.service';
```
  </action>
  <verify>
Run `npm run typecheck` to verify all modifications compile. Then run `npm run lint` to check for lint errors in the modified files. Verify:
- BalanceTable.tsx accepts `onChatClick` prop and renders MessageCircle icon
- AnnualBalancePage.tsx renders BalanceChatSheet with state management
- index.ts exports all new components and chat types
  </verify>
  <done>
BalanceTable shows a chat icon (MessageCircle) on each row that calls `onChatClick`. AnnualBalancePage manages chat open/close state and renders BalanceChatSheet. Module index.ts exports all new chat components and types. `npm run typecheck` and `npm run lint` pass.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript:** `npm run typecheck` passes with 0 errors
2. **Lint:** `npm run lint` passes (or only pre-existing errors, no new ones in modified files)
3. **Files exist:**
   - `src/modules/annual-balance/components/BalanceChatSheet.tsx`
   - `src/modules/annual-balance/components/BalanceChatMessages.tsx`
   - `src/modules/annual-balance/components/BalanceChatInput.tsx`
4. **Key patterns verified:**
   - BalanceChatSheet imports from `balance-chat.service` (not from `modules/chat/`)
   - BalanceChatMessages uses `user_id` for own-message check (not `sender_id`)
   - BalanceTable has `onChatClick` prop with `MessageCircle` icon
   - AnnualBalancePage renders `<BalanceChatSheet>` with open/close state
   - All text is Hebrew (no English user-facing strings)
   - Sheet uses `side="left"` and `dir="rtl"`
</verification>

<success_criteria>
- 3 new component files created and type-checked
- 3 existing files modified (BalanceTable, AnnualBalancePage, index.ts)
- Chat icon visible on every balance table row
- Clicking chat icon opens Sheet side panel with message list and input
- Loading spinner shows while fetching messages
- Empty state shows Hebrew text when no messages exist
- Sending a message adds it optimistically before server confirms
- All Hebrew text is right-aligned in RTL layout
- `npm run typecheck` and `npm run lint` pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-chat-ui-components/03-01-SUMMARY.md`
</output>
