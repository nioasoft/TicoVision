---
phase: 01-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260209_balance_chat_messages.sql
  - src/types/database.types.ts
autonomous: true

must_haves:
  truths:
    - "balance_chat_messages table exists with correct columns (id, tenant_id, balance_id, user_id, content, message_type, is_deleted, deleted_at, deleted_by, created_at)"
    - "RLS policies prevent users from reading or writing messages outside their tenant"
    - "INSERT policy enforces user_id = auth.uid() so users cannot impersonate others"
    - "UPDATE policy restricts soft-delete operations to admin and accountant roles"
    - "No DELETE policy exists (soft delete only, hard delete impossible)"
    - "Database queries on (tenant_id, balance_id, created_at) use index scan, not sequential scan"
    - "Table is included in supabase_realtime publication for Phase 4 live delivery"
    - "TypeScript types are regenerated to include balance_chat_messages"
  artifacts:
    - path: "supabase/migrations/20260209_balance_chat_messages.sql"
      provides: "DDL for balance_chat_messages table, indexes, RLS policies, Realtime publication"
      contains: "CREATE TABLE.*balance_chat_messages"
    - path: "src/types/database.types.ts"
      provides: "Generated TypeScript types including balance_chat_messages"
      contains: "balance_chat_messages"
  key_links:
    - from: "balance_chat_messages.tenant_id"
      to: "tenants.id"
      via: "REFERENCES tenants(id) ON DELETE CASCADE"
      pattern: "REFERENCES tenants"
    - from: "balance_chat_messages.balance_id"
      to: "annual_balance_sheets.id"
      via: "REFERENCES annual_balance_sheets(id) ON DELETE CASCADE"
      pattern: "REFERENCES annual_balance_sheets"
    - from: "RLS policies"
      to: "get_current_tenant_id() + user_tenant_access"
      via: "Policy USING/WITH CHECK clauses"
      pattern: "get_current_tenant_id.*user_tenant_access"
---

<objective>
Create the `balance_chat_messages` database table with tenant isolation, RLS policies, performance indexes, and Realtime publication membership. This is the data foundation that all subsequent chat phases build upon.

Purpose: Establish the schema for per-balance-sheet chat messages with proper multi-tenant security, audit trail (soft delete), and real-time readiness.
Output: One migration file applied to Supabase, regenerated TypeScript types.
</objective>

<execution_context>
@/Users/asafbenatia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/asafbenatia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply balance_chat_messages migration with table, indexes, RLS, and Realtime</name>
  <files>supabase/migrations/20260209_balance_chat_messages.sql</files>
  <action>
Apply a Supabase migration named `balance_chat_messages` with the following DDL. Use the Supabase MCP `apply_migration` tool.

**Table definition:**
```sql
CREATE TABLE IF NOT EXISTS balance_chat_messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  balance_id UUID NOT NULL REFERENCES annual_balance_sheets(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  content TEXT NOT NULL CHECK (char_length(content) > 0 AND char_length(content) <= 5000),
  message_type TEXT NOT NULL DEFAULT 'user' CHECK (message_type IN ('user', 'system')),
  is_deleted BOOLEAN NOT NULL DEFAULT false,
  deleted_at TIMESTAMPTZ,
  deleted_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Indexes (4 total):**
1. Composite query index: `idx_bcm_tenant_balance_created ON balance_chat_messages(tenant_id, balance_id, created_at)` — primary query pattern
2. FK index: `idx_bcm_balance_id ON balance_chat_messages(balance_id)` — JOIN performance
3. FK index: `idx_bcm_user_id ON balance_chat_messages(user_id)` — JOIN performance
4. Partial index: `idx_bcm_active_messages ON balance_chat_messages(tenant_id, balance_id, created_at) WHERE is_deleted = false` — filters out soft-deleted

**RLS policies (3 total, NO delete policy):**
1. `bcm_select_own_tenant` FOR SELECT — `is_super_admin(auth.uid())` OR (tenant matches via `get_current_tenant_id()` AND user exists in `user_tenant_access` with `is_active = true`)
2. `bcm_insert_own_tenant` FOR INSERT — same as SELECT but WITH CHECK also enforces `user_id = auth.uid()` to prevent impersonation
3. `bcm_update_admin_accountant` FOR UPDATE — same tenant check but restricted to `role IN ('admin', 'accountant')` for soft-delete operations

**Realtime publication:**
```sql
ALTER PUBLICATION supabase_realtime ADD TABLE balance_chat_messages;
```

**Important details:**
- Use `gen_random_uuid()` NOT `uuid_generate_v4()` (project convention)
- Use `get_current_tenant_id()` NOT direct JWT extraction (modern pattern per research)
- Include `message_type` column now to avoid Phase 8 schema migration later
- No `updated_at` column — messages are write-once (only `is_deleted` changes, tracked by `deleted_at`)
- `ON DELETE CASCADE` on both `tenant_id` and `balance_id` FKs

Refer to the complete migration SQL in `.planning/phases/01-database-foundation/01-RESEARCH.md` (Code Examples section) as the source of truth, but add the `message_type` column as specified above.
  </action>
  <verify>
Run these verification queries via Supabase MCP `execute_sql`:

1. Verify table columns:
```sql
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns
WHERE table_name = 'balance_chat_messages'
ORDER BY ordinal_position;
```
Expected: 10 columns (id, tenant_id, balance_id, user_id, content, message_type, is_deleted, deleted_at, deleted_by, created_at)

2. Verify RLS enabled:
```sql
SELECT relrowsecurity FROM pg_class WHERE relname = 'balance_chat_messages';
```
Expected: `relrowsecurity = true`

3. Verify indexes:
```sql
SELECT indexname FROM pg_indexes WHERE tablename = 'balance_chat_messages' ORDER BY indexname;
```
Expected: 5 indexes (PK + 4 custom)

4. Verify RLS policies:
```sql
SELECT policyname, cmd FROM pg_policies WHERE tablename = 'balance_chat_messages' ORDER BY policyname;
```
Expected: 3 policies (bcm_insert_own_tenant, bcm_select_own_tenant, bcm_update_admin_accountant)

5. Verify Realtime publication:
```sql
SELECT tablename FROM pg_publication_tables WHERE pubname = 'supabase_realtime' AND tablename = 'balance_chat_messages';
```
Expected: 1 row
  </verify>
  <done>
Table `balance_chat_messages` exists with 10 columns, 4 custom indexes, 3 RLS policies (SELECT/INSERT/UPDATE, no DELETE), RLS enabled, and table is in `supabase_realtime` publication. INSERT policy enforces `user_id = auth.uid()`. UPDATE policy restricts to admin/accountant roles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Regenerate TypeScript types from updated schema</name>
  <files>src/types/database.types.ts</files>
  <action>
Generate updated TypeScript types that include the new `balance_chat_messages` table.

Use the Supabase MCP `generate_typescript_types` tool to get the latest types from the database schema. Then update `src/types/database.types.ts` with the generated output.

After updating, verify the generated types include the `balance_chat_messages` table with all expected columns typed correctly:
- `id: string` (UUID)
- `tenant_id: string` (UUID)
- `balance_id: string` (UUID)
- `user_id: string` (UUID)
- `content: string`
- `message_type: string` (default 'user')
- `is_deleted: boolean` (default false)
- `deleted_at: string | null` (TIMESTAMPTZ, nullable)
- `deleted_by: string | null` (UUID, nullable)
- `created_at: string`
  </action>
  <verify>
1. Run `npm run typecheck` from project root to verify TypeScript compilation passes with the new types.
2. Grep the types file for `balance_chat_messages` to confirm the table is included:
```bash
grep -c "balance_chat_messages" src/types/database.types.ts
```
Expected: At least 1 match (the table definition in the generated types).
  </verify>
  <done>
`src/types/database.types.ts` contains generated types for `balance_chat_messages` with all 10 columns properly typed. `npm run typecheck` passes.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run the full verification suite:

1. **Schema verification** — All 10 columns exist with correct types, nullability, and defaults
2. **Security verification** — RLS is enabled, 3 policies exist (SELECT, INSERT, UPDATE), no DELETE policy
3. **Performance verification** — 4 custom indexes exist (composite, 2 FK, 1 partial)
4. **Realtime verification** — Table is in `supabase_realtime` publication
5. **Type safety verification** — `npm run typecheck` passes, `database.types.ts` includes `balance_chat_messages`
6. **Constraint verification** — Content length CHECK constraint (1-5000 chars), message_type CHECK ('user'|'system')
</verification>

<success_criteria>
- `balance_chat_messages` table is live in Supabase with all columns, constraints, indexes, and RLS policies
- RLS prevents cross-tenant access (SELECT, INSERT, UPDATE all scoped to tenant)
- INSERT enforces `user_id = auth.uid()` preventing message impersonation
- Only admin/accountant roles can UPDATE (for soft-delete)
- Hard DELETE is impossible (no DELETE policy)
- Table is ready for Realtime subscriptions (Phase 4)
- TypeScript types are regenerated and typecheck passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-foundation/01-01-SUMMARY.md`
</output>
