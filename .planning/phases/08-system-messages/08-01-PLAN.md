---
phase: 08-system-messages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/modules/annual-balance/services/balance-chat.service.ts
  - src/modules/annual-balance/services/annual-balance.service.ts
  - src/modules/annual-balance/components/BalanceChatMessages.tsx
autonomous: true

must_haves:
  truths:
    - "When an auditor is assigned, a system message appears in the balance chat with the auditor's name"
    - "When balance status changes (forward or revert), a system message records the transition with Hebrew labels"
    - "When an auditor confirms assignment, a system message appears in chat"
    - "When materials are marked as received, a system message appears in the balance chat"
    - "System messages render as centered pills with an info icon, visually distinct from user bubbles"
    - "System messages cannot be deleted by users (no delete UI shown)"
  artifacts:
    - path: "src/modules/annual-balance/services/balance-chat.service.ts"
      provides: "sendSystemMessage() method for fire-and-forget system message insertion"
      contains: "sendSystemMessage"
    - path: "src/modules/annual-balance/services/annual-balance.service.ts"
      provides: "System message calls in assignAuditor, updateStatus, and confirmAssignment"
      contains: "balanceChatService.sendSystemMessage"
    - path: "src/modules/annual-balance/components/BalanceChatMessages.tsx"
      provides: "Conditional rendering for system messages with centered pill style"
      contains: "message_type"
  key_links:
    - from: "src/modules/annual-balance/services/annual-balance.service.ts"
      to: "src/modules/annual-balance/services/balance-chat.service.ts"
      via: "balanceChatService.sendSystemMessage() called fire-and-forget after assignAuditor/updateStatus/confirmAssignment"
      pattern: "balanceChatService\\.sendSystemMessage"
    - from: "src/modules/annual-balance/components/BalanceChatMessages.tsx"
      to: "balance_chat_messages.message_type column"
      via: "conditional rendering checks msg.message_type === 'system'"
      pattern: "msg\\.message_type.*system"
---

<objective>
Add automatic system messages to the balance chat timeline for key events: auditor assignment, status changes (forward and revert), and auditor confirmation.

Purpose: Create an audit trail in the chat that makes it clear when status transitions and assignments happen, visible to all chat participants.
Output: sendSystemMessage() service method, 3 integration points in annualBalanceService, and system message UI rendering in BalanceChatMessages.
</objective>

<execution_context>
@/Users/asafbenatia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/asafbenatia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-system-messages/08-RESEARCH.md

# Key source files
@src/modules/annual-balance/services/balance-chat.service.ts
@src/modules/annual-balance/services/annual-balance.service.ts
@src/modules/annual-balance/components/BalanceChatMessages.tsx
@src/modules/annual-balance/types/balance-chat.types.ts
@src/modules/annual-balance/types/annual-balance.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sendSystemMessage method and wire into annualBalanceService events</name>
  <files>
    src/modules/annual-balance/services/balance-chat.service.ts
    src/modules/annual-balance/services/annual-balance.service.ts
  </files>
  <action>
**Step 1: Add `sendSystemMessage()` to BalanceChatService** (`balance-chat.service.ts`)

Add a new method after the existing `sendMessage()` method:

```typescript
/**
 * Insert a system-generated message into the balance chat.
 * Used for auditor assignment notifications, status change records,
 * and auditor confirmation events.
 * Non-critical: errors are logged but do not propagate to caller.
 *
 * @param balanceId - The balance sheet ID
 * @param content - Hebrew message text describing the event
 * @returns null on success, error on failure
 */
async sendSystemMessage(
  balanceId: string,
  content: string
): Promise<ServiceResponse<null>> {
  try {
    const tenantId = await this.getTenantId();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      return { data: null, error: new Error('User not authenticated') };
    }

    const { error } = await supabase
      .from('balance_chat_messages')
      .insert({
        tenant_id: tenantId,
        balance_id: balanceId,
        user_id: user.id,
        content,
        message_type: 'system',
      });

    if (error) throw error;

    return { data: null, error: null };
  } catch (error) {
    console.error('Failed to send system message:', error);
    return { data: null, error: this.handleError(error as Error) };
  }
}
```

Key design notes:
- Uses the acting user's `user_id` (satisfies RLS INSERT policy `user_id = auth.uid()`)
- No content validation (unlike `sendMessage` which checks 1-5000 chars) -- system messages are short and controlled
- No audit log call (the parent operation already logs)
- Errors are caught and logged but never thrown -- system messages are non-critical

**Step 2: Wire into `annualBalanceService`** (`annual-balance.service.ts`)

Add import at top of file:
```typescript
import { balanceChatService } from './balance-chat.service';
import { BALANCE_STATUS_CONFIG } from '../types/annual-balance.types';
```

Note: `BALANCE_STATUS_CONFIG` is already imported via the destructured import of `BALANCE_STATUSES` and `isValidTransition`. Check if `BALANCE_STATUS_CONFIG` is already in the import. If not, add it to the existing import from `'../types/annual-balance.types'`.

**2a. In `updateStatus()` method** -- after the status history insert block (around line 432), before the `logAction` call, add:

```typescript
// System message in balance chat (fire-and-forget)
const fromLabel = BALANCE_STATUS_CONFIG[currentStatus].label;
const toLabel = BALANCE_STATUS_CONFIG[newStatus].label;
const systemContent = isRevert
  ? `סטטוס הוחזר: ${fromLabel} → ${toLabel}`
  : `סטטוס שונה: ${fromLabel} → ${toLabel}`;
balanceChatService.sendSystemMessage(id, systemContent);
```

Note: Uses `→` (Unicode arrow) not `->` for cleaner Hebrew text display.

**2b. In `assignAuditor()` method** -- after the status history block (around line 527), before the `logAction` call, add:

```typescript
// System message in balance chat (fire-and-forget)
// Wrap lookup + send in async IIFE so the await for auditor name
// does NOT block the parent operation (preserves fire-and-forget principle)
void (async () => {
  try {
    const { data: auditorInfo } = await supabase.rpc('get_user_with_auth', {
      p_user_id: auditorId,
    });
    const auditorDisplayName = auditorInfo?.[0]?.full_name || auditorInfo?.[0]?.email || '';
    balanceChatService.sendSystemMessage(id, `מאזן שויך למבקר ${auditorDisplayName}`);
  } catch {
    // Non-critical — silently ignore
  }
})();
```

Why an async IIFE: `assignAuditor()` does NOT already have the auditor display name available (it only receives `auditorId`). The name lookup requires an `await`, but the fire-and-forget principle says the parent operation must not block on system message logic. Wrapping both the lookup and the send in a `void` IIFE keeps the entire side-effect non-blocking.

**2c. In `confirmAssignment()` method** -- after the status history insert (around line 779), before the `logAction` call, add:

```typescript
// System message in balance chat (fire-and-forget)
balanceChatService.sendSystemMessage(id, 'מבקר אישר קבלת תיק');
```

**2d. In `markMaterialsReceived()` method** -- after the `logAction` call (around line 466), before the return, add:

```typescript
// System message in balance chat (fire-and-forget)
balanceChatService.sendSystemMessage(balanceSheetId, 'חומרים התקבלו');
```

All four calls are fire-and-forget (no `await`). They MUST NOT block the parent operation or cause it to fail if the system message insertion fails.
  </action>
  <verify>
    Run `npm run typecheck` -- no type errors in modified files.
    Run `npm run lint` -- no new lint errors in modified files (ignore pre-existing).
    Grep for `sendSystemMessage` in `annual-balance.service.ts` -- should appear 4 times (assignAuditor, updateStatus, confirmAssignment, markMaterialsReceived).
    Grep for `sendSystemMessage` in `balance-chat.service.ts` -- should appear 1 time (method definition).
  </verify>
  <done>
    - `sendSystemMessage()` exists on `BalanceChatService` and inserts a message with `message_type: 'system'`
    - `assignAuditor()` fires a system message with the auditor's display name (lookup + send wrapped in async IIFE, non-blocking)
    - `updateStatus()` fires a system message with Hebrew status labels (different prefix for forward vs revert)
    - `confirmAssignment()` fires a system message "מבקר אישר קבלת תיק"
    - `markMaterialsReceived()` fires a system message "חומרים התקבלו"
    - All calls are fire-and-forget (no await on parent flow, no error propagation)
  </done>
</task>

<task type="auto">
  <name>Task 2: Render system messages as centered pills and prevent deletion</name>
  <files>
    src/modules/annual-balance/components/BalanceChatMessages.tsx
  </files>
  <action>
**Step 1: Add `Info` icon import**

Add `Info` to the lucide-react import at line 13:
```typescript
import { Loader2, Info } from 'lucide-react';
```

**Step 2: Add system message rendering branch**

Inside the `messages.map()` callback (line 72), after the date separator logic and before the existing user message `<div>` (line 87), add a conditional early return for system messages:

```typescript
// System messages: centered pill with info icon
if (msg.message_type === 'system') {
  return (
    <div key={msg.id}>
      {showDateSeparator && (
        <div className="flex items-center justify-center my-3">
          <span className="text-xs text-muted-foreground bg-gray-100 px-3 py-1 rounded-full">
            {msgDate}
          </span>
        </div>
      )}
      <div className="flex items-center justify-center my-2">
        <div className="inline-flex items-center gap-1.5 text-xs text-muted-foreground bg-muted/50 border border-border/50 px-3 py-1.5 rounded-full max-w-[85%]">
          <Info className="h-3 w-3 shrink-0" />
          <span className="text-center">{msg.content}</span>
        </div>
      </div>
    </div>
  );
}
```

This goes BEFORE the existing `return (` at line 78 (the user message rendering). The system message branch must be placed so that when `msg.message_type === 'system'`, it returns the pill rendering and skips the user bubble rendering entirely.

**Visual design rationale:**
- `bg-muted/50` + `border-border/50` = subtle background distinct from user bubbles
- `rounded-full` = pill shape matching date separator style
- `text-xs text-muted-foreground` = smaller, muted text for informational messages
- `Info` icon (3x3) = visual cue that this is a system event
- `max-w-[85%]` = prevents overflow on long status change messages
- No sender name, no timestamp, no delete action = system messages are anonymous events

**What NOT to do:**
- Do NOT add any delete/soft-delete UI for system messages
- Do NOT show `sender_name` for system messages (the acting user's identity is stored in `user_id` for audit but not displayed)
- Do NOT add timestamps to system messages (they appear inline in the chronological flow, the date separator provides context)
  </action>
  <verify>
    Run `npm run typecheck` -- no type errors.
    Run `npm run lint` -- no new lint errors.
    Run `npm run build` -- build succeeds.
    Visually inspect: system messages in the JSX use `justify-center`, `rounded-full`, `Info` icon, and have no sender name or delete action.
  </verify>
  <done>
    - System messages render as centered pills with muted background, border, and Info icon
    - System messages do NOT show sender name or timestamp
    - System messages do NOT have any delete/edit UI
    - User messages continue rendering unchanged (own=primary, other=gray)
    - Date separators work correctly for both message types
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with no new errors
2. `npm run lint` passes with no new errors in modified files
3. `npm run build` succeeds
4. `balance-chat.service.ts` contains `sendSystemMessage` method with `message_type: 'system'`
5. `annual-balance.service.ts` contains 4 fire-and-forget `sendSystemMessage` calls (assignAuditor, updateStatus, confirmAssignment, markMaterialsReceived)
6. `BalanceChatMessages.tsx` has conditional rendering for `msg.message_type === 'system'` with centered pill style
7. System messages have no delete UI and no sender name display
</verification>

<success_criteria>
- System messages automatically appear in balance chat when auditor is assigned, status changes, auditor confirms, or materials received
- System messages are visually distinct (centered pill with Info icon) from user messages (left/right bubbles)
- System messages cannot be deleted or edited
- System message failures do not block parent operations (fire-and-forget pattern)
- All 4 event types produce appropriate Hebrew text
</success_criteria>

<output>
After completion, create `.planning/phases/08-system-messages/08-01-SUMMARY.md`
</output>
