---
phase: 10-polish-edge-cases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/modules/annual-balance/components/BalanceChatSheet.tsx
  - src/modules/annual-balance/components/BalanceChatInput.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "When message fetch fails, user sees Hebrew error message with a retry button that re-fetches messages"
    - "When message send fails, toast notification includes a 'retry' action that re-sends the same content"
    - "When user goes offline, a yellow banner appears in the chat header saying 'no internet connection'"
    - "User can type multi-line messages using Shift+Enter for newlines and Enter to send"
    - "Only one Toaster instance exists in the app (no duplicate toasts)"
  artifacts:
    - path: "src/modules/annual-balance/components/BalanceChatSheet.tsx"
      provides: "Error state with retry, send retry via toast, offline banner"
      contains: "setError"
    - path: "src/modules/annual-balance/components/BalanceChatInput.tsx"
      provides: "Auto-expanding Textarea replacing single-line Input"
      contains: "Textarea"
    - path: "src/App.tsx"
      provides: "Single Toaster instance (duplicate removed)"
  key_links:
    - from: "src/modules/annual-balance/components/BalanceChatSheet.tsx"
      to: "BalanceChatMessages"
      via: "error and onRetry props"
      pattern: "error=.*onRetry="
---

<objective>
Add error handling with retry mechanisms, offline detection, multiline input, and fix the duplicate Toaster.

Purpose: Addresses success criteria 1 (network failure recovery), 2 (send error retry), and foundational UX polish (multiline input, duplicate toast fix).
Output: BalanceChatSheet with error/retry/offline states, BalanceChatInput with Textarea, App.tsx with single Toaster.
</objective>

<execution_context>
@/Users/asafbenatia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/asafbenatia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-polish-edge-cases/10-RESEARCH.md
@src/modules/annual-balance/components/BalanceChatSheet.tsx
@src/modules/annual-balance/components/BalanceChatInput.tsx
@src/modules/annual-balance/components/BalanceChatMessages.tsx
@src/App.tsx
@src/main.tsx
@src/components/ui/textarea.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error state with retry, send retry toast, and offline banner to BalanceChatSheet</name>
  <files>
    src/modules/annual-balance/components/BalanceChatSheet.tsx
    src/App.tsx
  </files>
  <action>
**BalanceChatSheet.tsx changes:**

1. Add `error` state: `const [error, setError] = useState<string | null>(null);`

2. Add `isOnline` state with navigator.onLine listener:
```typescript
const [isOnline, setIsOnline] = useState(navigator.onLine);

useEffect(() => {
  const handleOnline = () => setIsOnline(true);
  const handleOffline = () => setIsOnline(false);
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  return () => {
    window.removeEventListener('online', handleOnline);
    window.removeEventListener('offline', handleOffline);
  };
}, []);
```

3. Extract `fetchMessages` to a stable callback (outside the useEffect) so it can be passed as onRetry:
```typescript
const fetchMessages = useCallback(async () => {
  if (!balanceCase?.id) return;
  setLoading(true);
  setError(null);
  const result = await balanceChatService.getMessages(balanceCase.id);
  if (result.error) {
    setError('שגיאה בטעינת ההודעות');
  } else {
    setMessages(result.data ?? []);
    // Build user map (existing logic)
    ...
  }
  setLoading(false);
  // markAsRead (existing logic)
  ...
}, [balanceCase?.id, user]);
```
Keep the existing `useEffect` for open/balanceCase change, but call `fetchMessages()` from it. Keep the `cancelled` guard for cleanup.

4. Pass `error` and `onRetry={fetchMessages}` as new props to `BalanceChatMessages`:
```tsx
<BalanceChatMessages
  messages={messages}
  loading={loading}
  currentUserId={user?.id || ''}
  error={error}
  onRetry={fetchMessages}
/>
```

5. Modify `handleSend` to include toast retry action when send fails. Instead of:
```typescript
toast.error('שגיאה בשליחת ההודעה');
```
Use:
```typescript
toast.error('שגיאה בשליחת ההודעה', {
  action: {
    label: 'נסה שוב',
    onClick: () => handleSend(content),
  },
});
```
This preserves the message content in the closure so the user can retry without retyping.

6. Add offline banner between SheetHeader and BalanceChatMessages:
```tsx
{!isOnline && (
  <div className="text-xs text-amber-600 flex items-center gap-1.5 px-4 py-1.5 bg-amber-50 border-b">
    <WifiOff className="h-3 w-3 shrink-0" />
    <span>אין חיבור לאינטרנט</span>
  </div>
)}
```
Import `WifiOff` from `lucide-react`.

7. Also disable the BalanceChatInput when offline by passing `disabled={!balanceCase || !isOnline}`.

**App.tsx change:**

Remove the duplicate Toaster. The `main.tsx` already renders a fully-configured `<Toaster>` with `richColors`, `dir="rtl"`, `duration={6000}`, `expand={true}`, `closeButton={true}`. The `App.tsx` Toaster at line 105 (`<Toaster position="top-center" />`) is a duplicate.

1. Remove the `import { Toaster } from '@/components/ui/sonner';` line from App.tsx
2. Remove `<Toaster position="top-center" />` from the JSX (line 105)

**Do NOT** add custom WebSocket reconnection logic — Supabase JS handles this automatically.
  </action>
  <verify>
Run `npm run typecheck` to verify no TypeScript errors. Grep for `Toaster` in src/App.tsx — should find zero matches. Grep for `setError` in BalanceChatSheet.tsx — should find matches. Grep for `isOnline` in BalanceChatSheet.tsx — should find matches.
  </verify>
  <done>
BalanceChatSheet shows error state with retry button when fetch fails. Send failure toast has "נסה שוב" action button. Offline banner appears when navigator.onLine is false. Only one Toaster exists in the app (in main.tsx).
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert BalanceChatInput from single-line Input to auto-expanding Textarea</name>
  <files>
    src/modules/annual-balance/components/BalanceChatInput.tsx
  </files>
  <action>
Replace the `<Input>` element with an auto-expanding `<Textarea>` that:
- Starts at 1 row height (not the default 80px min-height)
- Grows as user types multi-line content, up to ~120px max
- Preserves Enter-to-send and Shift+Enter-for-newline behavior
- Maintains RTL text alignment

**Specific changes:**

1. Replace import: `import { Input } from '@/components/ui/input';` → `import { Textarea } from '@/components/ui/textarea';`

2. Add a ref for the textarea and an auto-resize effect:
```typescript
const textareaRef = useRef<HTMLTextAreaElement>(null);

// Auto-resize textarea height based on content
useEffect(() => {
  const el = textareaRef.current;
  if (!el) return;
  el.style.height = 'auto';
  el.style.height = `${Math.min(el.scrollHeight, 120)}px`;
}, [text]);
```

3. Replace the `<Input>` JSX with:
```tsx
<Textarea
  ref={textareaRef}
  value={text}
  onChange={(e) => setText(e.target.value)}
  onKeyDown={handleKeyDown}
  placeholder="כתוב הודעה..."
  className="rtl:text-right min-h-[38px] max-h-[120px] resize-none py-2 text-sm"
  disabled={sending || disabled}
  rows={1}
/>
```

Key details:
- `min-h-[38px]` overrides textarea.tsx default `min-h-[80px]` so it starts compact (like an Input)
- `max-h-[120px]` caps growth at ~4 lines
- `resize-none` prevents manual resize handle
- `rows={1}` starts as single line
- `text-sm` matches the chat message text size
- Keep the existing `handleKeyDown` which already handles Enter vs Shift+Enter

4. Reset height after send: In `handleSend`, after `setText('')`, the useEffect will auto-shrink back to 1 row since content is empty.

5. Update the JSDoc at the top to mention "auto-expanding Textarea" instead of "Text input".
  </action>
  <verify>
Run `npm run typecheck`. Grep BalanceChatInput.tsx for `Textarea` — should find import and usage. Grep for `Input` — should NOT find the old Input component import (though "Input" may appear in the interface name `BalanceChatInputProps` which is fine).
  </verify>
  <done>
Chat input starts as single-line, expands to up to 4 lines as user types multiline content. Enter sends, Shift+Enter adds newline. Input shrinks back after sending.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors in modified files
2. `npm run lint` shows no new errors in modified files
3. `npm run build` succeeds
4. Grep confirms: single Toaster in main.tsx, zero Toasters in App.tsx
5. BalanceChatSheet has error state, retry callback, offline detection
6. BalanceChatInput uses Textarea with auto-expand
</verification>

<success_criteria>
- Network failure on message fetch shows Hebrew error with retry button
- Send failure toast includes retry action preserving message content
- Offline state shows yellow banner and disables input
- Multi-line message input works with Shift+Enter
- No duplicate toasts in the app
</success_criteria>

<output>
After completion, create `.planning/phases/10-polish-edge-cases/10-01-SUMMARY.md`
</output>
